# Server
## 程序功能
拓扑图
![图片](https://user-images.githubusercontent.com/110660943/185570800-fccea92b-b2da-418d-96c7-a26a70dde950.png)
程序说明：模拟用户刷卡开锁后，服务器接收门口机发出的卡相应信息（源楼层和目的楼层）和Raley实际收到梯控控制信息后对应的编号通路信息（呼梯与授权）与提前配置好的正确数据进行对比，判断Raley收到的控制信息是否正确。
## 设计思路
### 一、程序包涵四个线程，主线程和三个子线程。
其中三个子线程，两个用于监听信息，一个用于判断。
子线程1：监听门口机的UDP信息，并将门口机信息和获得信息的时间戳存入相应队列。
子线程2：监听Raley的UPD信息，并将Raley信息和获得信息的时间戳存入相应队列。
子线程3：每100ms进行一次判断，以门口机消息为基准判断一个时间窗口（-500ms,2000ms）内消息的完整性与正确性（即门口机1条消息，Raley2条消息）。
![图片](https://user-images.githubusercontent.com/110660943/185571108-97611704-28ac-40da-8e3b-f77f24b1e848.png)

### 二、数据处理（异常处理）
1.若超过（循环时间+2）s时间仍未收到门口机信息，判定门口机信息超时。
2.若收到门口机信息2s后，Raley队列在时间窗口内的信息为0条，判定Raley消息超时。
3.若收到门口机信息2s后，Raley队列在时间窗口内的信息为1条，判定Raley消息未收全。
4.若收到门口机信息2s后，Raley队列在时间窗口内的信息大于等于2条，进入判断，若Raley队列在时间窗口内的信息中存在门口机对应事件的Raley消息则为正确事件，否则为错误事件。
5.若门口机信息在配置文件中无匹配的内容，判定无门口机匹配事件，即错误事件。
6.收到门口机消息2000ms之后到下一次收到门口机消息前500ms之间收到的消息判定为超时消息，删除后不予以判断。

### 三、其他信息
1.用文本文件incident.txt来储存自己正确的配置，用于后续的判断部分。
2.判断线程休眠时间 = 100ms，时间窗口=（-500ms,2000ms）
3.信息判断的同时将结果存入本地数据库inc_history中的history表，后续可以根据该表查看历史记录。
用户名：root
密码：123456
4.监听门口机端口和Raley的端口以及配置文件可以在程序开始前进行修改。
5.收全3条消息，大致需要2s左右，故门口机配置文件中配置文件的循环秒数必须大于等于3s防止消息的混杂，判断错误。
![图片](https://user-images.githubusercontent.com/110660943/185571685-7f69f61a-d76b-4c1c-999e-d4c2c288cdf8.png)



## 使用方法 (mian函数位于Test.java)
### 程序开始前：
### 首先用sql文件建立inc_history数据库和history表。（首次运行前需要）否则信息无法存入日志表。
主界面
![](img//%E5%9B%BE%E7%89%871.png)
1.修改配置文件：
门口机（源楼层/目的楼层）Raley（编号/通路）
添加：添加表格行数
删除：删除行（需要选中一行）
保存：文件保存（仅保存信息完整的事件）
取消：不保存修改的内容
![](https://github.com/rileyii/Server/blob/main/img/%E5%9B%BE%E7%89%872.png)
  

二、修改门口机和Raley端口
两个端口不能相同，且是在1-63352之间的整数。
![](https://github.com/rileyii/Server/blob/main/img/%E5%9B%BE%E7%89%873.png)


三、查看历史记录
点击查看历史记录按钮，打开history.txt文件查看
![图片](https://user-images.githubusercontent.com/110660943/185571912-2d8f2135-f8a5-45ae-9cc0-89a91f78bd53.png)


### 程序开始：
 输入门口机配置文件中，信息发送的间隔时间（需要符合大于等于5秒），程序需要根据此来判断线程的休眠时间。
![](https://github.com/rileyii/Server/blob/main/img/%E5%9B%BE%E7%89%875.png)
收到的信息和信息比对消息会出现在右边的文本栏中。开始后，无法编辑表格内容和修改端口号，可以查看历史记录和退出程序。
此后可以查看文本栏部分，或者历史记录部分查看发送数据和表格数据的对比结果。
![图片](https://user-images.githubusercontent.com/110660943/185572000-74f4cb61-80ed-4e5e-8ee2-f6b687b050c3.png)

